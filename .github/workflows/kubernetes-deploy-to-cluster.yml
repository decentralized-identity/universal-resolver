name: AWS Kubernetes deployment

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Import Secrets
      uses: hashicorp/vault-action@v3
      with:
        url: ${{ secrets.VAULT_ADDR }}
        token: ${{ secrets.CI_SECRET_READER_PERIODIC_TOKEN }}
        caCertificate: ${{ secrets.VAULTCA }}
        secrets: |
          ci/data/gh-workflows/universal-resolver-cluster dif-cluster-kube-config | KUBE_CONFIG_DATA ;
          ci/data/gh-workflows/universal-resolver-cluster aws-access-key-id | AWS_ACCESS_KEY_ID ;
          ci/data/gh-workflows/universal-resolver-cluster aws-secret-access-key | AWS_SECRET_ACCESS_KEY ;
          ci/data/gh-workflows/universal-resolver-cluster rpc-url-testnet | RPC_URL_TESTNET ;
          ci/data/gh-workflows/universal-resolver-cluster rpc-cert-testnet | RPC_CERT_TESTNET ;
          ci/data/gh-workflows/deployment-status slack-webhook-url | SLACK_WEBHOOK_URL

    - name: Deploy to AWS Kubernetes Cluster
      uses: ./ci/deploy-k8s-aws
      with:
        kube-config-data: ${{ env.KUBE_CONFIG_DATA }}
        aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
        namespace: 'uni-resolver'
        rpc-url-testnet: ${{ env.RPC_URL_TESTNET }}
        rpc-cert-testnet: ${{ env.RPC_CERT_TESTNET }}

    - name: Slack notification
      if: failure()
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        fields: repo,commit,action,eventName,ref,workflow
      env:
        SLACK_WEBHOOK_URL: ${{ env.SLACK_WEBHOOK_URL }}
